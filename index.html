<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áŸáŸ’á€áŸ‚á“áœááŸ’áá˜á¶á“ - Mikids</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Khmer OS Battambang', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f0f2f5; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 380px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-save { background: #007bff; color: white; }
        .btn-in { background: #28a745; color: white; margin-bottom: 10px; }
        .btn-out { background: #dc3545; color: white; }
        .hidden { display: none !important; }
        .info-box { background: #f8f9fa; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="title">Mikids Attendance</h2>

    <div id="reg-form" class="hidden">
        <p>áŸá¼á˜á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡áŠá¾á˜áŸ’á”á¸áŸáŸ’á€áŸ‚á“ (ááŸ‚á˜áŸ’áá„á‚ááŸ‹)</p>
        <input type="text" id="fname" placeholder="áˆáŸ’á˜áŸ„áŸ‡á–áŸá‰">
        <input type="text" id="frole" placeholder="áá½á“á¶á‘á¸">
        <button class="btn-save" onclick="doRegister()">ášá€áŸ’áŸá¶á‘á»á€ á“á·á„á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</button>
    </div>

    <div id="att-form" class="hidden">
        <div class="info-box">
            <span style="color: #888; font-size: 12px;">áŸáŸ’áœá¶á‚á˜á“áŸ</span><br>
            <b id="user-name" style="font-size: 18px; color: #007bff;"></b><br>
            <span id="user-role" style="font-size: 13px; color: #555;"></span>
        </div>
        <button class="btn-in" onclick="sendToSystem('Check In')">Check In (á…á¼á›)</button>
        <button class="btn-out" onclick="sendToSystem('Check Out')">Check Out (á…áŸá‰)</button>
        <button style="background:none; color:#ccc; font-size:10px; margin-top:20px;" onclick="clearData()">á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡ááŸ’á˜á¸</button>
    </div>
</div>

<script>
    // á€á¶ášá€áŸ†áááŸ‹á–áŸááŸŒá˜á¶á“á”áŸ’ášá–áŸá“áŸ’á’
    const TELEGRAM_TOKEN = '8242266919:AAGE6uMJ_-UvM-3KBZkJVFhJyTLvcTVW5tQ';
    const CHAT_ID = '-1003584563383';
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbx1cktfgeEfjtrvAJ5FWvn0Qgw6Szi7uxYWF6SLODsjRvACyG6OfZJSuzaMKPS1tAy3/exec";

    window.onload = function() {
        checkUser();
    };

    function checkUser() {
        const saved = localStorage.getItem('mikids_v3');
        if (saved) {
            const user = JSON.parse(saved);
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('user-role').innerText = user.role;
            document.getElementById('att-form').classList.remove('hidden');
            document.getElementById('reg-form').classList.add('hidden');
            document.getElementById('title').innerText = "á€ááŸ‹ááŸ’ášá¶áœááŸ’áá˜á¶á“";
        } else {
            document.getElementById('reg-form').classList.remove('hidden');
            document.getElementById('att-form').classList.add('hidden');
        }
    }

    function doRegister() {
        const name = document.getElementById('fname').value.trim();
        const role = document.getElementById('frole').value.trim();
        if(!name || !role) return Swal.fire('áŸá¼á˜á”áŸ†á–áŸá‰á±áŸ’á™á‚áŸ’ášá”áŸ‹!', '', 'warning');
        localStorage.setItem('mikids_v3', JSON.stringify({ name, role }));
        checkUser();
    }

    async function sendToSystem(status) {
        Swal.fire({ title: 'á€áŸ†á–á»á„á”á‰áŸ’á‡á¼á“...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const user = JSON.parse(localStorage.getItem('mikids_v3'));
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        const date = now.toLocaleDateString("en-GB");

        // áŸ¡. á•áŸ’á‰á¾á‘áŸ… Google Sheets
        const sheetData = { date, name: user.name, role: user.role, type: status, time, reason: "" };
        try {
            await fetch(SHEET_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(sheetData) });
        } catch (e) { console.log("Sheet Error"); }

        // áŸ¢. á•áŸ’á‰á¾á‘áŸ… Telegram
        let msg = `ğŸ“Š <b>ášá”á¶á™á€á¶ášááŸáœááŸ’áá˜á¶á“</b>\n`;
        msg += `ğŸ‘¤ áˆáŸ’á˜áŸ„áŸ‡: ${user.name}\n`;
        msg += `ğŸ’¼ áá½á“á¶á‘á¸: ${user.role}\n`;
        msg += `ğŸš¦ áŸáŸ’áá¶á“á—á¶á–: ${status === 'Check In' ? 'âœ… á…á¼á›á’áŸ’áœá¾á€á¶áš' : 'ğŸšª á…áŸá‰á–á¸á’áŸ’áœá¾á€á¶áš'}\n`;
        msg += `â° á˜áŸ‰áŸ„á„: ${time}\nğŸ“… ááŸ’á„áŸƒá‘á¸: ${date}`;

        const teleUrl = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=HTML`;
        
        fetch(teleUrl).then(() => {
            Swal.fire('á‡áŸ„á‚á‡áŸá™!', 'áœááŸ’áá˜á¶á“ááŸ’ášá¼áœá”á¶á“ášá€áŸ’áŸá¶á‘á»á€ á“á·á„á•áŸ’á‰á¾á‘áŸ…ááŸá¡áŸá€áŸ’ášá¶á˜', 'success');
        });
    }

    function clearData() {
        if(confirm("á›á»á”áˆáŸ’á˜áŸ„áŸ‡á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?")) {
            localStorage.removeItem('mikids_v3');
            location.reload();
        }
    }
</script>
</body>
</html>
