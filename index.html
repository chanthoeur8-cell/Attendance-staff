<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <title>Staff Attendance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial,"Noto Sans Khmer",sans-serif; background:#f2f4f7; display:flex; justify-content:center; padding:20px; }
        .card { background:#fff; max-width:380px; padding:20px; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.1); }
        h2 { text-align:center; margin-bottom:14px }
        label { font-size:14px; font-weight:bold; }
        input, select, textarea { width:100%; padding:10px; margin:6px 0 12px; border-radius:8px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; }
        textarea { display:none; height:60px; }
        .time-box { background:#eef2ff; padding:10px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:12px; }
        button { width:100%; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer; }
        button:active { background:#1e40af; }
        #qrcode { display:flex; justify-content:center; margin-top:10px; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸ“‹ Staff Attendance</h2>
    <label>áˆáŸ’á˜áŸ„áŸ‡á–áŸá‰</label>
    <input id="name" placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡">
    <label>áá½á“á¶á‘á¸</label>
    <input id="role" placeholder="á”á‰áŸ’á…á¼á›áá½á“á¶á‘á¸">
    <label>á”áŸ’ášá—áŸá‘</label>
    <select id="type" onchange="checkTime()">
        <option value="checkin">Check-in</option>
        <option value="checkout">Check-out</option>
    </select>
    <div class="time-box" id="timeBox"></div>
    <label id="reasonLabel" style="display:none;color:red;">á˜á¼á›á áŸáá» (á™áºá/á…áŸá‰á˜á»á“)</label>
    <textarea id="reason" placeholder="áŸá¼á˜á”áŸ†á–áŸá‰á˜á¼á›á áŸáá»"></textarea>
    <button onclick="processAttendance()">Send to Telegram</button>
    <div id="qrcode"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const TELEGRAM_BOT_TOKEN = "8242266919:AAGE6uMJ_-UvM-3KBZkJVFhJyTLvcTVW5tQ";
const TELEGRAM_CHAT_ID = "1346632543";
const OFFICIAL_IN = "07:15";
const OFFICIAL_OUT = "17:15";

function getNow(){
    const now = new Date();
    const time = now.toTimeString().slice(0,5);
    const date = now.toLocaleDateString("en-GB");
    return {time,date};
}

function checkTime(){
    const {time} = getNow();
    const type = document.getElementById("type").value;
    const reason = document.getElementById("reason");
    const label = document.getElementById("reasonLabel");
    let needReason = false;
    if(type==="checkin" && time > OFFICIAL_IN) needReason=true;
    if(type==="checkout" && time < OFFICIAL_OUT) needReason=true;
    reason.style.display = needReason ? "block" : "none";
    label.style.display = needReason ? "block" : "none";
}

function updateTime(){
    const {time,date} = getNow();
    document.getElementById("timeBox").innerText = `ğŸ•’ ${time} | ğŸ“… ${date}`;
    checkTime();
}
updateTime();
setInterval(updateTime,60000);

async function sendToTelegram(message) {
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    try {
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: "HTML"
            })
        });
        const data = await response.json();
        if (!response.ok) {
            alert("Telegram Error: " + data.description);
            return false;
        }
        return true;
    } catch (error) {
        alert("Network Error!");
        return false;
    }
}

async function processAttendance() {
    const name = document.getElementById("name").value;
    const role = document.getElementById("role").value;
    const type = document.getElementById("type").value;
    const reason = document.getElementById("reason").value;
    const {time, date} = getNow();

    if(!name || !role){
        alert("áŸá¼á˜á”áŸ†á–áŸá‰áˆáŸ’á˜áŸ„áŸ‡ á“á·á„ áá½á“á¶á‘á¸");
        return;
    }

    let displayText = `ğŸ“‹ <b>Attendance Report</b>\n\n`;
    displayText += `ğŸ‘¤ <b>Name:</b> ${name}\n`;
    displayText += `ğŸ’¼ <b>Role:</b> ${role}\n`;
    displayText += `ğŸ“Š <b>Status:</b> ${type === 'checkin' ? 'ğŸŸ¢ Check-in' : 'ğŸ”´ Check-out'}\n`;
    displayText += `ğŸ“… <b>Date:</b> ${date}\n`;
    displayText += `ğŸ•’ <b>Time:</b> ${time}`;
    if(reason) displayText += `\nâš ï¸ <b>Reason:</b> ${reason}`;

    let qrText = `Attendance\nName: ${name}\nRole: ${role}\nType: ${type}\nDate: ${date}\nTime: ${time}`;
    if(reason) qrText += `\nReason: ${reason}`;

    document.getElementById("qrcode").innerHTML="";
    new QRCode(document.getElementById("qrcode"), {
        text: qrText,
        width: 200,
        height: 200,
        colorDark: "#2563eb",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });

    const success = await sendToTelegram(displayText);
    if(success) {
        alert("âœ… á”á¶á“á•áŸ’á‰á¾á‘áŸ… Telegram ášá½á…ášá¶á›áŸ‹!");
    }
}
</script>
</body>
</html>
