<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mikids Attendance</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{
    font-family: 'Khmer OS Battambang', Arial, sans-serif;
    background:#f0f2f5;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    margin:0;
}
.container{
    background:#fff;
    width:90%;
    max-width:380px;
    padding:30px;
    border-radius:20px;
    box-shadow:0 4px 15px rgba(0,0,0,.1);
    text-align:center;
}
h2{margin-bottom:20px;}
input{
    width:100%;
    padding:12px;
    margin:10px 0;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:14px;
}
button{
    width:100%;
    padding:14px;
    border:none;
    border-radius:12px;
    font-size:16px;
    font-weight:bold;
    margin-top:10px;
    cursor:pointer;
}
.btn-save{background:#007bff;color:#fff;}
.btn-in{background:#28a745;color:#fff;}
.btn-out{background:#dc3545;color:#fff;}
.hidden{display:none;}
.info{
    background:#f8f9fa;
    border-radius:15px;
    padding:15px;
    margin-bottom:20px;
}
.small-btn{
    background:none;
    color:#999;
    font-size:12px;
}
</style>
</head>

<body>

<div class="container">
    <h2 id="title">Mikids Attendance</h2>

    <!-- REGISTER -->
    <div id="register" class="hidden">
        <p>សូមចុះឈ្មោះ (តែម្តង)</p>
        <input id="name" placeholder="ឈ្មោះពេញ">
        <input id="role" placeholder="តួនាទី">
        <button class="btn-save" onclick="saveUser()">រក្សាទុក</button>
    </div>

    <!-- ATTENDANCE -->
    <div id="attendance" class="hidden">
        <div class="info">
            <b id="showName"></b><br>
            <span id="showRole"></span>
        </div>

        <button class="btn-in" onclick="sendData('Check In')">Check In (ចូល)</button>
        <button class="btn-out" onclick="sendData('Check Out')">Check Out (ចេញ)</button>

        <button class="small-btn" onclick="resetUser()">ចុះឈ្មោះថ្មី</button>
    </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz5X2j6hX7SWDhnjEzvShvTSYPgi6CC_tGBmiMZ6axFlPcqTL2PDfSsnueHPs7meY6X/exec";

window.onload = checkUser;

function checkUser(){
    const user = localStorage.getItem("mikids_user");
    if(user){
        const u = JSON.parse(user);
        showName.innerText = u.name;
        showRole.innerText = u.role;
        register.classList.add("hidden");
        attendance.classList.remove("hidden");
    }else{
        register.classList.remove("hidden");
    }
}

function saveUser(){
    const n = name.value.trim();
    const r = role.value.trim();
    if(!n || !r){
        Swal.fire("សូមបំពេញឱ្យគ្រប់","","warning");
        return;
    }
    localStorage.setItem("mikids_user", JSON.stringify({name:n, role:r}));
    checkUser();
}

async function sendData(type){
    const u = JSON.parse(localStorage.getItem("mikids_user"));
    const now = new Date();

    const payload = {
        name: u.name,
        role: u.role,
        type: type,
        date: now.toLocaleDateString("en-GB"),
        time: now.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})
    };

    Swal.fire({title:"កំពុងផ្ញើ...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});

    await fetch(WEB_APP_URL,{
        method:"POST",
        mode:"no-cors",
        body:JSON.stringify(payload)
    });

    Swal.fire("ជោគជ័យ!","បានកត់ត្រាវត្តមាន","success");
}

function resetUser(){
    if(confirm("តើចង់លុបទិន្នន័យមែនទេ?")){
        localStorage.removeItem("mikids_user");
        location.reload();
    }
}
</script>

</body>
</html>
